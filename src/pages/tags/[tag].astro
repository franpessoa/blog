---
import type { GetStaticPaths } from "astro";
import BaseLayout from "/src/layouts/BaseLayout.astro";
import BlogPostCard from "/src/components/BlogPostCard.astro";
import { getCollection } from "astro:content";

export const getStaticPaths = (async () => {
    // taken from https://docs.astro.build/en/tutorial/5-astro-api/2/#advanced-javascript-generate-pages-from-existing-tags
    const allPosts: any[] = await getCollection("posts");
    console.log(allPosts);

    const uniqueTags = [
        ...new Set(allPosts.map((post: any) => post.data.tags).flat()),
    ];

    console.log(uniqueTags);

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter((post: any) =>
            post.data.tags.includes(tag),
        );

        return {
            params: { tag },
            props: { filteredPosts: filteredPosts },
        };
    });
}) satisfies GetStaticPaths;

const { tag } = Astro.params;
const { filteredPosts } = Astro.props;
---

<BaseLayout title={tag}>
    <h1>Tag: #{tag}</h1>
    <ul>
        {
            filteredPosts.map((post: any) => (
                <BlogPostCard
                    url={"/" + post.id}
                    title={post.data.title}
                    up={post.data.up}
                    mod={post.data.mod}
                />
            ))
        }
    </ul>
</BaseLayout>
